<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerNavigator - Êô∫ËÉΩËÅå‰∏öËßÑÂàíÂä©Êâã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .chat-bubble { max-width: 80%; border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; }
        .chat-bubble-user { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .chat-bubble-bot { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 0.25rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" v-cloak class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 flex items-center justify-center gap-2">
                <i class="fas fa-compass"></i> CareerNavigator
            </h1>
            <p class="text-gray-600 mt-2">Âü∫‰∫é AI ÁöÑÊô∫ËÉΩËÅå‰∏öËßÑÂàí‰∏éÂØºËà™Á≥ªÁªü</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Step 1: Questionnaire -->
            <section v-if="currentStep === 'questionnaire'" class="bg-white rounded-xl shadow-md p-6 md:p-8">
                <h2 class="text-xl font-semibold mb-6 border-b pb-2">‰∏™‰∫∫‰ø°ÊÅØÈóÆÂç∑</h2>
                <form @submit.prevent="startPlanning" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Âπ¥ÈæÑ</label>
                            <input v-model.number="profile.age" type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Â≠¶ÂéÜ</label>
                            <select v-model="profile.education_level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                                <option value="Êú¨Áßë">Êú¨Áßë</option>
                                <option value="Á°ïÂ£´">Á°ïÂ£´</option>
                                <option value="ÂçöÂ£´">ÂçöÂ£´</option>
                                <option value="Â§ß‰∏ì">Â§ß‰∏ì</option>
                                <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Â∑•‰ΩúÂπ¥Èôê</label>
                            <input v-model.number="profile.work_experience" type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ÂΩìÂâçËÅå‰Ωç</label>
                            <input v-model="profile.current_position" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="‰æãÂ¶ÇÔºöËΩØ‰ª∂Â∑•Á®ãÂ∏à" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ÊâÄÂú®Ë°å‰∏ö</label>
                            <input v-model="profile.industry" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="‰æãÂ¶ÇÔºö‰∫íËÅîÁΩë" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ÊâÄÂú®Âú∞Âå∫</label>
                            <input v-model="profile.location" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="‰æãÂ¶ÇÔºöÂåó‰∫¨" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">ÊäÄËÉΩ (ÈÄóÂè∑ÂàÜÈöî)</label>
                        <input v-model="skillsInput" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="Python, React, È°πÁõÆÁÆ°ÁêÜ">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">ÂÖ¥Ë∂£Áà±Â•Ω (ÈÄóÂè∑ÂàÜÈöî)</label>
                        <input v-model="interestsInput" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="‰∫∫Â∑•Êô∫ËÉΩ, ÊëÑÂΩ±, ÂæíÊ≠•">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">ËÅå‰∏öÁõÆÊ†á</label>
                        <textarea v-model="profile.career_goals" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="ÊèèËø∞ÊÇ®Êú™Êù•ÁöÑËÅå‰∏öÊÑøÊôØ" required></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ëñ™ËµÑÊúüÊúõ</label>
                        <input v-model="profile.salary_expectation" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="‰æãÂ¶ÇÔºö30-50‰∏á">
                    </div>

                    <div class="pt-4">
                        <button type="submit" :disabled="loading" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-semibold flex items-center justify-center gap-2">
                            <span v-if="loading" class="animate-spin"><i class="fas fa-spinner"></i></span>
                            <span v-else>ÂºÄÂßãËÅå‰∏öËßÑÂàí</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- Step 2: Interactive Workflow -->
            <section v-if="currentStep === 'workflow'" class="flex flex-col h-[70vh]">
                <!-- Chat History -->
                <div class="flex-1 overflow-y-auto bg-white rounded-t-xl shadow-md p-4 space-y-4" ref="chatContainer">
                    <div v-for="(msg, index) in chatHistory" :key="index" :class="['flex flex-col', msg.role === 'user' ? 'items-end' : 'items-start']">
                        <div :class="['chat-bubble', msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot']">
                            <div v-if="msg.type === 'text'" class="whitespace-pre-wrap">{{ msg.content }}</div>
                            
                            <!-- Report Display -->
                            <div v-if="msg.type === 'report'" class="space-y-4">
                                <h3 class="font-bold text-lg border-b pb-1 mb-2">üìä ËÅå‰∏öËßÑÂàíÂàÜÊûêÊä•Âëä</h3>
                                
                                <!-- ÈîôËØØÊèêÁ§∫ -->
                                <div v-if="msg.content.error" class="bg-red-50 p-3 rounded border-l-4 border-red-500 text-red-700 text-xs mb-2">
                                    <p class="font-bold">‚ö†Ô∏è ÂàÜÊûêÂºÇÂ∏∏</p>
                                    <p>{{ msg.content.error }}</p>
                                </div>

                                <div v-if="msg.content.executive_summary" class="bg-blue-50 p-3 rounded border-l-4 border-blue-500">
                                    <p class="text-sm italic">{{ msg.content.executive_summary }}</p>
                                </div>
                                
                                <div class="space-y-4 mt-4">
                                    <!-- ‰∏™‰∫∫ÂàÜÊûê -->
                                    <div v-if="msg.content.personal_analysis" class="bg-white p-3 rounded-lg border shadow-sm">
                                        <h4 class="font-bold text-blue-700 text-sm mb-2 flex items-center gap-2">
                                            <i class="fas fa-user-check"></i> ‰∏™‰∫∫ËÉΩÂäõÂàÜÊûê
                                        </h4>
                                        <p class="text-xs text-gray-700 leading-relaxed">{{ msg.content.personal_analysis }}</p>
                                    </div>

                                    <!-- Ë°å‰∏öÊú∫‰ºö -->
                                    <div v-if="msg.content.industry_opportunities" class="bg-white p-3 rounded-lg border shadow-sm">
                                        <h4 class="font-bold text-green-700 text-sm mb-2 flex items-center gap-2">
                                            <i class="fas fa-lightbulb"></i> Ë°å‰∏öÊú∫‰ºöÂàÜÊûê
                                        </h4>
                                        <p class="text-xs text-gray-700 leading-relaxed">{{ msg.content.industry_opportunities }}</p>
                                    </div>

                                    <!-- ËÅå‰∏öÂåπÈÖçÂ∫¶ -->
                                    <div v-if="msg.content.career_match" class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-bold text-purple-800 text-sm">üéØ ËÅå‰∏öÂåπÈÖçËØÑ‰º∞</h4>
                                            <span class="text-xl font-black text-purple-600">{{ msg.content.career_match.match_score }}%</span>
                                        </div>
                                        <div class="space-y-2">
                                            <div v-if="msg.content.career_match.match_reasons">
                                                <p class="text-[10px] font-bold text-purple-700 uppercase tracking-wider">ÂåπÈÖç‰ºòÂäø</p>
                                                <ul class="text-xs list-disc list-inside text-gray-700">
                                                    <li v-for="reason in msg.content.career_match.match_reasons">{{ reason }}</li>
                                                </ul>
                                            </div>
                                            <div v-if="msg.content.career_match.concerns">
                                                <p class="text-[10px] font-bold text-amber-700 uppercase tracking-wider">ÊΩúÂú®ÊåëÊàò</p>
                                                <ul class="text-xs list-disc list-inside text-gray-700">
                                                    <li v-for="concern in msg.content.career_match.concerns">{{ concern }}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ÂèëÂ±ïÂª∫ËÆÆ -->
                                    <div v-if="msg.content.development_plan" class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <div v-for="(plan, period) in msg.content.development_plan" :key="period" class="p-2 rounded border bg-gray-50">
                                            <p class="text-[10px] font-bold text-gray-500 uppercase mb-1">{{ period === 'short_term' ? 'Áü≠Êúü' : (period === 'medium_term' ? '‰∏≠Êúü' : 'ÈïøÊúü') }}Âª∫ËÆÆ</p>
                                            <ul class="text-[11px] list-disc list-inside text-gray-600">
                                                <li v-for="item in plan">{{ item }}</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- È£éÈô©ÊèêÁ§∫ -->
                                    <div v-if="msg.content.risk_warnings" class="p-3 bg-red-50 rounded-lg border border-red-100">
                                        <h4 class="font-bold text-red-800 text-sm mb-1 flex items-center gap-2">
                                            <i class="fas fa-exclamation-triangle"></i> È£éÈô©ÊèêÁ§∫
                                        </h4>
                                        <ul class="text-xs list-disc list-inside text-red-700">
                                            <li v-for="risk in msg.content.risk_warnings">{{ risk }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Goals Display -->
                            <div v-if="msg.type === 'goals'" class="space-y-4">
                                <h3 class="font-bold text-lg border-b pb-1 mb-2">üéØ ËÅå‰∏öÁõÆÊ†áÊãÜËß£</h3>
                                <div class="space-y-6">
                                    <div v-for="(goals, type) in { 'Áü≠ÊúüÁõÆÊ†á (3-12‰∏™Êúà)': msg.content.short_term_goals, '‰∏≠ÊúüÁõÆÊ†á (1-3Âπ¥)': msg.content.medium_term_goals, 'ÈïøÊúüÁõÆÊ†á (3-5Âπ¥)': msg.content.long_term_goals }" :key="type">
                                        <div v-if="goals && goals.length > 0">
                                            <h4 class="font-bold text-gray-800 text-sm mb-3 flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full" :class="type.includes('Áü≠Êúü') ? 'bg-green-500' : (type.includes('‰∏≠Êúü') ? 'bg-blue-500' : 'bg-purple-500')"></span>
                                                {{ type }}
                                            </h4>
                                            <div class="space-y-3 ml-4">
                                                <div v-for="goal in goals" :key="goal.title" class="bg-white p-3 rounded-lg border shadow-sm">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <h5 class="font-bold text-gray-900 text-xs">{{ goal.title }}</h5>
                                                        <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500">{{ goal.timeline }}</span>
                                                    </div>
                                                    <p class="text-[11px] text-gray-600 mb-2">{{ goal.description }}</p>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 pt-2 border-t border-gray-50">
                                                        <div>
                                                            <p class="text-[9px] font-bold text-gray-400 uppercase">ÊâÄÈúÄÊäÄËÉΩ</p>
                                                            <div class="flex flex-wrap gap-1 mt-1">
                                                                <span v-for="skill in goal.required_skills" class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">{{ skill }}</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <p class="text-[9px] font-bold text-gray-400 uppercase">ÂÖ≥ÈîÆÈáåÁ®ãÁ¢ë</p>
                                                            <ul class="text-[10px] list-disc list-inside text-gray-500 mt-1">
                                                                <li v-for="ms in goal.milestones">{{ ms }}</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Final Plan Display -->
                            <div v-if="msg.type === 'plan'" class="space-y-4">
                                <h3 class="font-bold text-lg border-b pb-1 mb-2">üìÖ ËÅå‰∏öË°åÂä®ËÆ°Âàí</h3>
                                
                                <div v-if="msg.content.schedule_overview" class="bg-gray-50 p-3 rounded border-l-4 border-gray-400 mb-4">
                                    <p class="text-sm italic">{{ msg.content.schedule_overview }}</p>
                                </div>

                                <!-- ÊØèÂë®ËÆ°Âàí -->
                                <div v-if="msg.content.weekly_schedule" class="space-y-4">
                                    <h4 class="font-bold text-sm text-blue-700 flex items-center gap-2">
                                        <i class="fas fa-calendar-week"></i> ËøëÊúüÂë®ËÆ°Âàí
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div v-for="week in msg.content.weekly_schedule" :key="week.week" class="bg-white p-3 rounded-lg border shadow-sm">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-xs font-black text-blue-600">Á¨¨ {{ week.week }} Âë®</span>
                                                <span class="text-[10px] bg-blue-50 text-blue-500 px-2 py-0.5 rounded-full">{{ week.focus_area }}</span>
                                            </div>
                                            <div class="space-y-2">
                                                <div v-for="(task, tidx) in week.tasks" :key="tidx" class="border-l-2 border-gray-100 pl-2">
                                                    <p class="text-xs font-medium text-gray-800">{{ task.task }}</p>
                                                    <div class="flex justify-between items-center mt-1">
                                                        <span class="text-[10px] text-gray-400"><i class="far fa-clock"></i> {{ task.duration }}</span>
                                                        <span :class="['text-[9px] px-1 rounded', task.priority === 'È´ò' ? 'bg-red-50 text-red-500' : 'bg-gray-50 text-gray-500']">{{ task.priority }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ÊúàÂ∫¶ÈáåÁ®ãÁ¢ë -->
                                <div v-if="msg.content.monthly_milestones" class="mt-6">
                                    <h4 class="font-bold text-sm text-green-700 mb-3 flex items-center gap-2">
                                        <i class="fas fa-flag-checkered"></i> ÊúàÂ∫¶ÈáåÁ®ãÁ¢ë
                                    </h4>
                                    <div class="space-y-3">
                                        <div v-for="ms in msg.content.monthly_milestones" :key="ms.month" class="flex gap-3">
                                            <div class="flex flex-col items-center">
                                                <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xs font-bold">{{ ms.month }}Êúà</div>
                                                <div class="w-0.5 flex-1 bg-green-50 my-1"></div>
                                            </div>
                                            <div class="flex-1 bg-green-50/30 p-3 rounded-lg border border-green-100 mb-2">
                                                <h5 class="text-xs font-bold text-green-800">{{ ms.milestone }}</h5>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                                                    <div>
                                                        <p class="text-[9px] font-bold text-green-600 uppercase">‰∫§‰ªòÊàêÊûú</p>
                                                        <ul class="text-[10px] list-disc list-inside text-gray-600">
                                                            <li v-for="d in ms.deliverables">{{ d }}</li>
                                                        </ul>
                                                    </div>
                                                    <div>
                                                        <p class="text-[9px] font-bold text-green-600 uppercase">ÊàêÂäüÊåáÊ†á</p>
                                                        <ul class="text-[10px] list-disc list-inside text-gray-600">
                                                            <li v-for="s in ms.success_metrics">{{ s }}</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Â≠¶‰π†‰∏éËµÑÊ∫ê -->
                                <div v-if="msg.content.learning_plan" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="p-3 bg-amber-50 rounded-lg border border-amber-100">
                                        <h4 class="font-bold text-amber-800 text-sm mb-2 flex items-center gap-2">
                                            <i class="fas fa-graduation-cap"></i> Â≠¶‰π†ËÆ°Âàí
                                        </h4>
                                        <div class="space-y-2">
                                            <div v-if="msg.content.learning_plan.courses">
                                                <p class="text-[9px] font-bold text-amber-600 uppercase">Êé®ËçêËØæÁ®ã</p>
                                                <ul class="text-[10px] list-disc list-inside text-gray-700">
                                                    <li v-for="c in msg.content.learning_plan.courses">{{ c }}</li>
                                                </ul>
                                            </div>
                                            <div v-if="msg.content.learning_plan.books">
                                                <p class="text-[9px] font-bold text-amber-600 uppercase">Êé®Ëçê‰π¶Á±ç</p>
                                                <ul class="text-[10px] list-disc list-inside text-gray-700">
                                                    <li v-for="b in msg.content.learning_plan.books">{{ b }}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                                        <h4 class="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2">
                                            <i class="fas fa-users"></i> ‰∫∫ËÑâ‰∏éË∑üË∏™
                                        </h4>
                                        <div class="space-y-2">
                                            <div v-if="msg.content.networking_plan">
                                                <p class="text-[9px] font-bold text-blue-600 uppercase">‰∫∫ËÑâÂª∫ËÆæ</p>
                                                <ul class="text-[10px] list-disc list-inside text-gray-700">
                                                    <li v-for="n in msg.content.networking_plan">{{ n }}</li>
                                                </ul>
                                            </div>
                                            <div v-if="msg.content.progress_tracking">
                                                <p class="text-[9px] font-bold text-blue-600 uppercase">ËøõÂ∫¶Ë∑üË∏™</p>
                                                <ul class="text-[10px] list-disc list-inside text-gray-700">
                                                    <li v-for="p in msg.content.progress_tracking">{{ p }}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Streaming Content (Parallel Support) -->
                    <div v-if="Object.keys(activeNodes).length > 0" class="w-full">
                        <!-- Sequential Nodes (Standard Bubble) -->
                        <div v-for="(info, node) in activeNodes" :key="node">
                            <div v-if="!isParallelNode(node)" class="flex flex-col items-start mb-4">
                                <div class="chat-bubble chat-bubble-bot bg-blue-50 border border-blue-100 w-full">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="animate-pulse h-2 w-2 rounded-full bg-blue-500"></span>
                                        <span class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">{{ getNodeLabel(node) }} Ê≠£Âú®ÊÄùËÄÉ...</span>
                                    </div>
                                    <div class="text-sm whitespace-pre-wrap text-gray-700">{{ info.content || 'Ê≠£Âú®Â§ÑÁêÜ...' }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parallel Nodes (Grid) -->
                        <div v-if="hasParallelNodes" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div v-for="(info, node) in parallelNodes" :key="node" class="bg-white rounded-lg border-2 border-blue-100 shadow-sm overflow-hidden flex flex-col">
                                <div class="bg-blue-50 px-3 py-2 border-b border-blue-100 flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-blue-700 uppercase tracking-wider flex items-center gap-2">
                                        <i :class="getNodeIcon(node)"></i> {{ getNodeLabel(node) }}
                                    </span>
                                    <span class="flex h-2 w-2">
                                        <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-blue-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                                    </span>
                                </div>
                                <div class="p-3 flex-1">
                                    <div class="text-[11px] whitespace-pre-wrap text-gray-600 leading-relaxed h-48 overflow-y-auto">
                                        {{ info.content || 'Ê≠£Âú®ÂáÜÂ§áÂàÜÊûêÊï∞ÊçÆ...' }}
                                    </div>
                                </div>
                                <div class="bg-gray-50 px-3 py-1 text-[9px] text-gray-400 border-t flex justify-between">
                                    <span>Áä∂ÊÄÅ: {{ info.status === 'start' ? 'ÂàÜÊûê‰∏≠' : 'Â§ÑÁêÜ‰∏≠' }}</span>
                                    <span class="animate-pulse">‚óè</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div v-if="loading" class="flex items-start">
                        <div class="chat-bubble chat-bubble-bot flex items-center gap-2">
                            <span class="animate-bounce">‚óè</span>
                            <span class="animate-bounce" style="animation-delay: 0.2s">‚óè</span>
                            <span class="animate-bounce" style="animation-delay: 0.4s">‚óè</span>
                            <span class="ml-2 text-sm text-gray-500">AI Ê≠£Âú®ÊÄùËÄÉ‰∏≠...</span>
                        </div>
                    </div>
                </div>

                <!-- Input Area / Feedback Area -->
                <div class="bg-gray-100 p-4 rounded-b-xl border-t">
                    <!-- Feedback Form -->
                    <div v-if="waitingForFeedback" class="space-y-4">
                        <div v-if="pendingQuestions && pendingQuestions.length > 0" class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400 mb-4">
                            <p class="text-sm font-bold text-yellow-700 mb-1">AI ÊèêÂá∫‰∫Ü‰ª•‰∏ãÈóÆÈ¢òÔºö</p>
                            <ul class="text-xs list-disc list-inside text-yellow-600">
                                <li v-for="q in pendingQuestions">{{ q }}</li>
                            </ul>
                        </div>
                        <p class="text-sm font-medium text-gray-700">ÊÇ®ÂØπ‰∏äËø∞ÂàÜÊûêÊä•ÂëäÊª°ÊÑèÂêóÔºü</p>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="level in satisfactionLevels" :key="level.value" 
                                @click="submitFeedback(level.value)"
                                class="px-3 py-1 rounded-full text-xs border transition-colors"
                                :class="feedback.satisfaction === level.value ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:border-blue-500'">
                                {{ level.label }}
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <input v-model="feedback.text" type="text" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÂÖ∑‰ΩìÊÑèËßÅ (ÂèØÈÄâ)" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 text-sm border">
                            <button @click="submitFeedback(feedback.satisfaction)" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-semibold">Êèê‰∫§ÂèçÈ¶à</button>
                        </div>
                    </div>

                    <!-- Normal Chat Input (Disabled for now as it's workflow driven) -->
                    <div v-else-if="currentStage === 'completed'" class="text-center py-2">
                        <p class="text-green-600 font-semibold"><i class="fas fa-check-circle"></i> ËßÑÂàíÂ∑≤ÂÆåÊàêÔºÅ</p>
                        <button @click="reset" class="mt-2 text-blue-600 text-sm hover:underline">ÈáçÊñ∞ÂºÄÂßã</button>
                    </div>
                    <div v-else class="text-center py-2 text-gray-500 text-sm italic">
                        Â∑•‰ΩúÊµÅÊ≠£Âú®Ëá™Âä®ÊâßË°å‰∏≠...
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-400 text-xs">
            &copy; 2024 CareerNavigator. All rights reserved.
        </footer>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, nextTick, watch, computed } = Vue;

        createApp({
            setup() {
                const currentStep = ref('questionnaire'); // questionnaire, workflow
                const currentStage = ref('initial');
                const loading = ref(false);
                const sessionId = ref(null);
                const chatHistory = ref([]);
                const chatContainer = ref(null);
                const waitingForFeedback = ref(false);
                const pendingQuestions = ref([]);
                const activeNodes = reactive({});
                let pollTimer = null;

                watch(activeNodes, () => {
                    scrollToBottom();
                }, { deep: true });

                const isParallelNode = (node) => {
                    return ['user_profiler', 'industry_researcher', 'job_analyzer'].includes(node);
                };

                const parallelNodes = computed(() => {
                    const nodes = {};
                    for (const node in activeNodes) {
                        if (isParallelNode(node)) {
                            nodes[node] = activeNodes[node];
                        }
                    }
                    return nodes;
                });

                const hasParallelNodes = computed(() => Object.keys(parallelNodes.value).length > 0);

                const getNodeLabel = (node) => {
                    const labels = {
                        'coordinator': 'ÂçèË∞ÉÂëò',
                        'planner': 'ËÆ°ÂàíÂëò',
                        'supervisor': 'ÁÆ°ÁêÜÂëò',
                        'user_profiler': '‰∏™‰∫∫ÁîªÂÉèÂàÜÊûê',
                        'industry_researcher': 'Ë°å‰∏öË∂ãÂäøÁ†îÁ©∂',
                        'job_analyzer': 'ËÅå‰∏öÊú∫‰ºöÂàÜÊûê',
                        'reporter': 'Ê±áÊä•Âëò',
                        'goal_decomposer': 'ÁõÆÊ†áÊãÜËß£Âëò',
                        'scheduler': 'Êó•Á®ãËßÑÂàíÂëò',
                        'system': 'Á≥ªÁªü'
                    };
                    return labels[node] || node;
                };

                const getNodeIcon = (node) => {
                    const icons = {
                        'user_profiler': 'fas fa-user-cog',
                        'industry_researcher': 'fas fa-chart-line',
                        'job_analyzer': 'fas fa-briefcase',
                        'coordinator': 'fas fa-route',
                        'planner': 'fas fa-clipboard-list',
                        'goal_decomposer': 'fas fa-tasks',
                        'scheduler': 'fas fa-calendar-alt'
                    };
                    return icons[node] || 'fas fa-robot';
                };

                const profile = reactive({
                    age: 28,
                    education_level: 'Êú¨Áßë',
                    work_experience: 3,
                    current_position: 'ËΩØ‰ª∂Â∑•Á®ãÂ∏à',
                    industry: '‰∫íËÅîÁΩë',
                    location: 'Âåó‰∫¨',
                    career_goals: 'Â∏åÊúõËΩ¨Âêë AI ‰∫ßÂìÅÁªèÁêÜÊñπÂêëÂèëÂ±ï',
                    salary_expectation: '30-50‰∏á'
                });

                const skillsInput = ref('Python, JavaScript, React, SQL');
                const interestsInput = ref('‰∫∫Â∑•Êô∫ËÉΩ, ‰∫ßÂìÅËÆæËÆ°, ÂøÉÁêÜÂ≠¶');

                const feedback = reactive({
                    satisfaction: 'satisfied',
                    text: ''
                });

                const satisfactionLevels = [
                    { label: 'ÈùûÂ∏∏Êª°ÊÑè', value: 'very_satisfied' },
                    { label: 'Êª°ÊÑè', value: 'satisfied' },
                    { label: '‰∏ÄËà¨', value: 'neutral' },
                    { label: '‰∏çÊª°ÊÑè', value: 'dissatisfied' },
                    { label: 'ÈùûÂ∏∏‰∏çÊª°ÊÑè', value: 'very_dissatisfied' }
                ];

                const scrollToBottom = async () => {
                    await nextTick();
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                };

                const addMessage = (role, content, type = 'text') => {
                    chatHistory.value.push({ role, content, type });
                    scrollToBottom();
                };

                const startPlanning = async () => {
                    loading.value = true;
                    try {
                        const payload = {
                            user_profile: {
                                ...profile,
                                skills: skillsInput.value.split(',').map(s => s.trim()).filter(s => s),
                                interests: interestsInput.value.split(',').map(s => s.trim()).filter(s => s)
                            },
                            message: `ÊàëÊÉ≥ËøõË°åËÅå‰∏öËßÑÂàíÔºåÊàëÁöÑÁõÆÊ†áÊòØÔºö${profile.career_goals}`
                        };

                        const response = await axios.post('/api/career/start', payload);
                        if (response.data.success) {
                            sessionId.value = response.data.session_id;
                            currentStep.value = 'workflow';
                            addMessage('user', payload.message);
                            addMessage('bot', 'Êî∂Âà∞ÔºÅÊàëÂ∑≤ÂºÄÂßã‰∏∫ÊÇ®ÂàÜÊûêËÅå‰∏öË∑ØÂæÑÔºåËØ∑Á®çÂÄô...');
                            
                            // Start streaming
                            startStreaming();
                            // Start polling for status (to get final results)
                            pollStatus();
                        }
                    } catch (error) {
                        console.error(error);
                        alert('ÂêØÂä®Â§±Ë¥•: ' + (error.response?.data?.error || error.message));
                    } finally {
                        loading.value = false;
                    }
                };

                const startStreaming = () => {
                    if (!sessionId.value) return;
                    
                    // Reset active nodes
                    for (const key in activeNodes) delete activeNodes[key];
                    activeNodes['system'] = { content: 'Ê≠£Âú®ÂáÜÂ§áÂ∑•‰ΩúÊµÅ...', status: 'start' };
                    
                    const eventSource = new EventSource(`/api/career/stream?session_id=${sessionId.value}`);
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.status === 'completed' || data.status === 'error') {
                            eventSource.close();
                            // Clear active nodes after a short delay to let user see completion
                            setTimeout(() => {
                                for (const key in activeNodes) delete activeNodes[key];
                            }, 2000);
                            return;
                        }

                        if (data.node) {
                            if (data.status === 'start') {
                                // Â¶ÇÊûúÊòØÂπ∂Ë°åËäÇÁÇπÔºåÁõ¥Êé•Ê∑ªÂä†
                                if (isParallelNode(data.node)) {
                                    activeNodes[data.node] = { content: '', status: 'start' };
                                } else {
                                    // Â¶ÇÊûúÊòØÈ°∫Â∫èËäÇÁÇπÔºàÂ¶Ç coordinator, planner, supervisor, reporterÔºâ
                                    // Âè™ÊúâÂú®‰∏çÊòØ reporter ÁöÑÊó∂ÂÄôÊâçÊ∏ÖÁ©∫Âπ∂Ë°åËäÇÁÇπ
                                    // ËøôÊ†∑Âπ∂Ë°åÂàÜÊûêÁöÑÁªìÊûúÂèØ‰ª•‰∏ÄÁõ¥ÊòæÁ§∫Âà∞Êä•ÂëäÁîüÊàê
                                    if (data.node !== 'reporter' && data.node !== 'system') {
                                        for (const key in activeNodes) {
                                            delete activeNodes[key];
                                        }
                                    } else if (data.node === 'reporter') {
                                        // reporter ÂºÄÂßãÊó∂ÔºåÂè™Âà†Èô§‰πãÂâçÁöÑÈ°∫Â∫èËäÇÁÇπÔºå‰øùÁïôÂπ∂Ë°åËäÇÁÇπ
                                        for (const key in activeNodes) {
                                            if (!isParallelNode(key)) delete activeNodes[key];
                                        }
                                    }
                                    
                                    activeNodes[data.node] = { content: '', status: 'start' };
                                }
                                
                                // ÁßªÈô§Á≥ªÁªüÊ∂àÊÅØ
                                if (data.node !== 'system' && activeNodes['system']) {
                                    delete activeNodes['system'];
                                }
                            } else if (data.status === 'end') {
                                if (activeNodes[data.node]) {
                                    activeNodes[data.node].status = 'end';
                                    // For parallel nodes, we might want to keep them until all are done
                                    // For sequential nodes, we can remove them or keep them briefly
                                    if (['coordinator', 'planner', 'supervisor', 'reporter', 'goal_decomposer', 'scheduler'].includes(data.node)) {
                                        setTimeout(() => {
                                            delete activeNodes[data.node];
                                        }, 1000);
                                    }
                                }
                            } else if (data.content) {
                                if (!activeNodes[data.node]) {
                                    activeNodes[data.node] = { content: '', status: 'running' };
                                }
                                activeNodes[data.node].content += data.content;
                                activeNodes[data.node].status = 'running';
                            }
                        }
                    };

                    eventSource.onerror = (error) => {
                        console.error('Streaming error:', error);
                        eventSource.close();
                    };
                };

                const pollStatus = async () => {
                    if (!sessionId.value) return;
                    
                    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çËΩÆËØ¢
                    if (pollTimer) {
                        clearTimeout(pollTimer);
                        pollTimer = null;
                    }
                    
                    try {
                        const response = await axios.get(`/api/career/status/${sessionId.value}`);
                        const data = response.data;
                        
                        // ‰øÆÊ≠£Â≠óÊÆµËØªÂèñË∑ØÂæÑ
                        currentStage.value = data.stage_info.current_stage;
                        pendingQuestions.value = data.stage_info.pending_questions || [];
                        
                        // Ê£ÄÊü•ÁªìÊûú
                        if (data.results.integrated_report) {
                            const report = data.results.integrated_report;
                            const alreadyDisplayed = chatHistory.value.some(m => 
                                m.type === 'report' && 
                                (m.content.iteration_count === report.iteration_count || JSON.stringify(m.content) === JSON.stringify(report))
                            );
                            
                            if (!alreadyDisplayed) {
                                // Â¶ÇÊûúÊä•Âëä‰∏≠ÊúâÈîôËØØ‰ø°ÊÅØÔºåÊ∑ªÂä†Âà∞ÂÜÖÂÆπ‰∏≠ÊòæÁ§∫
                                if (report.error) {
                                    report.executive_summary = "‚ö†Ô∏è ÂàÜÊûêËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ: " + report.error;
                                }
                                addMessage('bot', report, 'report');
                            }
                        }

                        if (data.results.career_goals) {
                            const goals = data.results.career_goals;
                            const alreadyDisplayed = chatHistory.value.some(m => 
                                m.type === 'goals' && JSON.stringify(m.content) === JSON.stringify(goals)
                            );
                            
                            if (!alreadyDisplayed) {
                                addMessage('bot', goals, 'goals');
                            }
                        }

                        if (data.results.final_career_plan) {
                            const plan = data.results.final_career_plan;
                            const alreadyDisplayed = chatHistory.value.some(m => 
                                m.type === 'plan' && JSON.stringify(m.content) === JSON.stringify(plan)
                            );
                            
                            if (!alreadyDisplayed) {
                                addMessage('bot', plan, 'plan');
                            }
                        }

                        // Check if waiting for feedback
                        if (data.stage_info.requires_user_input) {
                            waitingForFeedback.value = true;
                            loading.value = false;
                            // ÂÅúÊ≠¢ËΩÆËØ¢ÔºåÁ≠âÂæÖÁî®Êà∑ËæìÂÖ•
                        } else if (currentStage.value === 'completed') {
                            waitingForFeedback.value = false;
                            loading.value = false;
                            // ÂÅúÊ≠¢ËΩÆËØ¢ÔºåÊµÅÁ®ãÁªìÊùü
                        } else {
                            // ÁªßÁª≠ËΩÆËØ¢
                            pollTimer = setTimeout(pollStatus, 2000);
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                        // Âá∫Èîô‰πüÂ∞ùËØïÁªßÁª≠ËΩÆËØ¢ÔºåÈô§Èùû‰ºöËØùÂ§±Êïà
                        pollTimer = setTimeout(pollStatus, 5000);
                    }
                };

                const submitFeedback = async (level) => {
                    feedback.satisfaction = level;
                    loading.value = true;
                    waitingForFeedback.value = false;
                    
                    try {
                        addMessage('user', `Êª°ÊÑèÂ∫¶: ${satisfactionLevels.find(l => l.value === level).label}. ${feedback.text}`);
                        
                        const response = await axios.post(`/api/career/feedback/${sessionId.value}`, {
                            satisfaction_level: level,
                            feedback_text: feedback.text
                        });
                        
                        if (response.data.success) {
                            addMessage('bot', response.data.message);
                            feedback.text = '';
                            // ÈáçÊñ∞ÂºÄÂßãÊµÅÂºèÁõëÂê¨Ôºå‰ª•Ëß¶ÂèëÂêéÁª≠ÊµÅÁ®ã
                            startStreaming();
                            pollStatus();
                        }
                    } catch (error) {
                        console.error(error);
                        alert('Êèê‰∫§ÂèçÈ¶àÂ§±Ë¥•');
                        waitingForFeedback.value = true;
                    } finally {
                        loading.value = false;
                    }
                };

                const reset = () => {
                    currentStep.value = 'questionnaire';
                    chatHistory.value = [];
                    sessionId.value = null;
                    waitingForFeedback.value = false;
                };

                return {
                    currentStep, profile, skillsInput, interestsInput, loading,
                    startPlanning, chatHistory, chatContainer, waitingForFeedback,
                    satisfactionLevels, feedback, submitFeedback, currentStage, reset,
                    activeNodes, getNodeLabel, getNodeIcon, isParallelNode, parallelNodes, hasParallelNodes
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
