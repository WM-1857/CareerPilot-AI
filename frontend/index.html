<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerNavigator - æ™ºèƒ½èŒä¸šè§„åˆ’åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }

        .chat-container { flex: 1; }
        .bot-icon {
            background: #f97316;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .bot-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .message-action-btn {
            color: #9ca3af;
            transition: color 0.2s;
            font-size: 14px;
        }
        .message-action-btn:hover { color: #4b5563; }
        
        .user-bubble {
            background-color: #f3f4f6;
            color: #1f2937;
            border-radius: 1.25rem;
            padding: 0.75rem 1.25rem;
            max-width: 80%;
        }
        
        .input-container {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Login Animation */
        .login-bg {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            overflow: hidden;
            position: relative;
        }
        .shape {
            position: absolute;
            filter: blur(40px);
            opacity: 0.4;
            animation: float 20s infinite alternate;
        }
        .shape-1 { width: 300px; height: 300px; background: #fb923c; top: -100px; left: -100px; border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
        .shape-2 { width: 400px; height: 400px; background: #fdba74; bottom: -150px; right: -100px; border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; animation-delay: -5s; }
        .shape-3 { width: 250px; height: 250px; background: #fed7aa; top: 20%; right: 10%; border-radius: 40% 60% 70% 30% / 40% 40% 60% 60%; animation-delay: -10s; }
        
        /* Questionnaire Decoration */
        .q-shape-left { width: 300px; height: 300px; background: #fb923c; top: 5%; left: -100px; border-radius: 40% 60% 70% 30%; opacity: 0.25; z-index: 0; filter: blur(50px); }
        .q-shape-right { width: 350px; height: 350px; background: #fdba74; bottom: 10%; right: -120px; border-radius: 30% 70% 40% 60%; opacity: 0.25; z-index: 0; animation-delay: -7s; filter: blur(50px); }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, 100px) rotate(20deg); }
        }

        .login-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.8);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: #f9fafb;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: #4b5563;
            font-size: 14px;
            font-medium;
            transition: all 0.2s;
            cursor: pointer;
        }
        .sidebar-item:hover {
            background-color: #f3f4f6;
            color: #111827;
        }
        .sidebar-item.active {
            background-color: #0d9488; /* Teal color from image */
            color: white;
            border-radius: 8px;
            margin: 0 12px;
        }
        .sidebar-item.active:hover {
            background-color: #0f766e;
        }
    </style>
</head>
<body class="bg-white text-gray-900 font-sans antialiased">
    <div id="app" v-cloak class="flex flex-col h-screen">
        <!-- Top Navigation -->
        <header v-if="currentStep !== 'login'" class="flex items-center justify-between px-6 py-4 border-b bg-white sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button v-if="currentStep === 'workflow'" @click="currentStep = 'questionnaire'" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h1 class="text-lg font-medium text-gray-800 flex items-center gap-2">
                    <span v-if="currentStep === 'questionnaire'"><i class="fas fa-compass text-orange-500"></i> CareerNavigator</span>
                    <span v-else>èŒä¸šè§„åˆ’åˆ†æä¸­</span>
                </h1>
            </div>
            <button @click="reset" class="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-redo-alt"></i> é‡æ–°å¼€å§‹
            </button>
        </header>

        <main class="flex-1 overflow-hidden flex flex-col">
            <!-- Step 0: Login Page -->
            <section v-if="currentStep === 'login'" class="flex-1 flex">
                <!-- Left: Animation -->
                <div class="hidden lg:flex lg:w-1/2 login-bg items-center justify-center p-12">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                    <div class="relative z-10 text-center">
                        <div class="w-24 h-24 bg-orange-500 rounded-3xl flex items-center justify-center text-white text-4xl mb-8 mx-auto shadow-2xl shadow-orange-200 rotate-12">
                            <i class="fas fa-compass"></i>
                        </div>
                        <h2 class="text-4xl font-bold text-gray-900 mb-4">CareerNavigator</h2>
                        <p class="text-gray-500 text-lg max-w-md mx-auto">åŸºäº AI çš„æ™ºèƒ½èŒä¸šè§„åˆ’ä¸å¯¼èˆªç³»ç»Ÿï¼Œä¸ºæ‚¨å¼€å¯èŒä¸šç”Ÿæ¶¯çš„æ–°ç¯‡ç« ã€‚</p>
                    </div>
                </div>
                <!-- Right: Login Form -->
                <div class="w-full lg:w-1/2 flex items-center justify-center p-8 bg-white">
                    <div class="max-w-md w-full space-y-8">
                        <div class="text-center lg:text-left">
                            <h2 class="text-3xl font-bold text-gray-900">æ¬¢è¿å›æ¥</h2>
                            <p class="text-gray-500 mt-2">è¯·è¾“å…¥æ‚¨çš„è´¦å·ä¿¡æ¯ä»¥ç»§ç»­</p>
                        </div>
                        <form @submit.prevent="handleLogin" class="space-y-6">
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <label class="text-sm font-medium text-gray-700">é‚®ç®±/ç”¨æˆ·å</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"><i class="far fa-envelope"></i></span>
                                        <input type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 pl-12 border" placeholder="name@example.com" required>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center">
                                        <label class="text-sm font-medium text-gray-700">å¯†ç </label>
                                        <a href="#" class="text-xs text-orange-600 hover:underline">å¿˜è®°å¯†ç ï¼Ÿ</a>
                                    </div>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-lock"></i></span>
                                        <input type="password" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 pl-12 border" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                                <label class="ml-2 text-sm text-gray-600">è®°ä½æˆ‘</label>
                            </div>
                            <button type="submit" class="w-full bg-gray-900 text-white py-4 rounded-xl hover:bg-black transition-all font-semibold shadow-lg shadow-gray-200">
                                ç™»å½•
                            </button>
                            <div class="relative py-4">
                                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                                <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400">æˆ–è€…é€šè¿‡ä»¥ä¸‹æ–¹å¼</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button type="button" class="flex items-center justify-center gap-2 py-3 border border-gray-100 rounded-xl hover:bg-gray-50 transition-all text-sm font-medium">
                                    <i class="fab fa-weixin text-green-500"></i> å¾®ä¿¡
                                </button>
                                <button type="button" class="flex items-center justify-center gap-2 py-3 border border-gray-100 rounded-xl hover:bg-gray-50 transition-all text-sm font-medium">
                                    <i class="fab fa-github"></i> GitHub
                                </button>
                            </div>
                        </form>
                        <p class="text-center text-sm text-gray-500">
                            è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" class="text-orange-600 font-bold hover:underline">ç«‹å³æ³¨å†Œ</a>
                        </p>
                    </div>
                </div>
            </section>

            <!-- Step 1: Questionnaire (Minimalist Card) -->
            <section v-if="currentStep === 'questionnaire'" class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 relative overflow-hidden">
                <!-- Background Decorations -->
                <div class="shape q-shape-left"></div>
                <div class="shape q-shape-right"></div>
                
                <div class="max-w-2xl mx-auto bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-gray-100 p-8 relative z-10">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">å¼€å¯æ‚¨çš„èŒä¸šå¯¼èˆª</h2>
                        <p class="text-gray-500 mt-2">è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼Œå¸®åŠ© AI ä¸ºæ‚¨é‡èº«å®šåˆ¶èŒä¸šè§„åˆ’æ–¹æ¡ˆã€‚</p>
                    </div>
                    
                    <form @submit.prevent="startPlanning" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">å¹´é¾„</label>
                                <input v-model.number="profile.age" type="number" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">å­¦å†</label>
                                <select v-model="profile.education_level" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" required>
                                    <option value="æœ¬ç§‘">æœ¬ç§‘</option>
                                    <option value="ç¡•å£«">ç¡•å£«</option>
                                    <option value="åšå£«">åšå£«</option>
                                    <option value="å¤§ä¸“">å¤§ä¸“</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">å·¥ä½œå¹´é™</label>
                                <input v-model.number="profile.work_experience" type="number" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">å½“å‰èŒä½</label>
                                <input v-model="profile.current_position" type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="ä¾‹å¦‚ï¼šè½¯ä»¶å·¥ç¨‹å¸ˆ" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">æ‰€åœ¨è¡Œä¸š</label>
                                <input v-model="profile.industry" type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="ä¾‹å¦‚ï¼šäº’è”ç½‘" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">æ‰€åœ¨åœ°åŒº</label>
                                <input v-model="profile.location" type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">æŠ€èƒ½ (é€—å·åˆ†éš”)</label>
                                <input v-model="skillsInput" type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="Python, React, é¡¹ç›®ç®¡ç†">
                            </div>
                            <div class="space-y-1">
                                <label class="text-sm font-medium text-gray-700">å…´è¶£çˆ±å¥½ (é€—å·åˆ†éš”)</label>
                                <input v-model="interestsInput" type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="äººå·¥æ™ºèƒ½, æ‘„å½±, å¾’æ­¥">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-sm font-medium text-gray-700">è–ªèµ„æœŸæœ›</label>
                            <input v-model="profile.salary_expectation" type="text" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="ä¾‹å¦‚ï¼š30-50ä¸‡">
                        </div>

                        <div class="space-y-1">
                            <label class="text-sm font-medium text-gray-700">èŒä¸šç›®æ ‡</label>
                            <textarea v-model="profile.career_goals" rows="3" class="w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all p-3 border" placeholder="æè¿°æ‚¨æœªæ¥çš„èŒä¸šæ„¿æ™¯" required></textarea>
                        </div>

                        <button type="submit" :disabled="loading" class="w-full bg-gray-900 text-white py-4 rounded-xl hover:bg-black transition-all font-semibold flex items-center justify-center gap-2 shadow-lg shadow-gray-200">
                            <span v-if="loading" class="animate-spin"><i class="fas fa-spinner"></i></span>
                            <span v-else>ç”Ÿæˆæˆ‘çš„èŒä¸šè§„åˆ’</span>
                        </button>
                    </form>
                </div>
            </section>

            <!-- Step 2: Interactive Workflow (Chat Style) -->
            <section v-if="currentStep === 'workflow'" class="flex-1 flex overflow-hidden">
                <!-- Sidebar -->
                <aside class="sidebar hidden md:flex py-6">
                    <div class="px-6 mb-8">
                        <div class="flex items-center gap-2 text-xl font-bold text-gray-900">
                            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white text-sm">
                                <i class="fas fa-compass"></i>
                            </div>
                            <span>CareerNavigator</span>
                        </div>
                    </div>

                    <nav class="flex-1 space-y-1">
                        <div class="sidebar-item">
                            <i class="fas fa-home w-5"></i> Home
                        </div>
                        <div class="sidebar-item active">
                            <i class="fas fa-plus-square w-5"></i> Find Activities
                        </div>
                        <div class="sidebar-item">
                            <i class="fas fa-history w-5"></i> History
                        </div>
                    </nav>

                    <div class="mt-auto pt-6 border-t border-gray-100 space-y-1">
                        <div class="sidebar-item">
                            <i class="fas fa-list-ul w-5"></i> Tutorial
                        </div>
                        <div class="sidebar-item">
                            <i class="fas fa-comment-alt w-5"></i> Feedback
                        </div>
                        <div class="sidebar-item">
                            <i class="fas fa-question-circle w-5"></i> Help
                        </div>
                        <div class="sidebar-item">
                            <i class="fas fa-info-circle w-5"></i> About
                        </div>
                        
                        <div class="px-4 py-4 mt-4 flex items-center gap-3 border-t border-gray-100">
                            <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-xs font-bold">
                                {{ profile.name ? profile.name.charAt(0).toUpperCase() : 'U' }}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-gray-900 truncate">{{ profile.name || 'User' }}</p>
                            </div>
                            <button @click="reset" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </aside>

                <!-- Main Chat Area -->
                <div class="flex-1 flex flex-col overflow-hidden bg-white relative">
                    <!-- Chat History -->
                    <div class="flex-1 overflow-y-auto px-4 py-8 chat-container" ref="chatContainer">
                        <div class="max-w-3xl mx-auto space-y-10">
                            <div v-for="(msg, index) in chatHistory" :key="index" class="flex flex-col">
                                <!-- Bot Message -->
                                <div v-if="msg.role === 'bot'" class="flex gap-4 items-start">
                                    <div class="bot-icon">
                                        <img src="bot-avatar.png" alt="AI">
                                    </div>
                                    <div class="flex-1 space-y-2">
                                    <div class="font-bold text-sm text-gray-800">CareerNavigator</div>
                                    <!-- Report Display -->
                                    <div v-if="msg.type === 'report'" class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm space-y-6">
                                        <h3 class="font-bold text-xl text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-chart-pie text-orange-500"></i> èŒä¸šè§„åˆ’åˆ†ææŠ¥å‘Š
                                        </h3>
                                        
                                        <div v-if="msg.content.executive_summary" class="bg-orange-50/50 p-4 rounded-xl text-gray-700 italic text-sm border-l-4 border-orange-400">
                                            {{ msg.content.executive_summary }}
                                        </div>
                                        
                                        <div class="grid grid-cols-1 gap-4">
                                            <div v-if="msg.content.personal_analysis" class="p-4 rounded-xl border border-gray-50 bg-gray-50/30">
                                                <h4 class="font-bold text-gray-800 text-sm mb-2 flex items-center gap-2">
                                                    <i class="fas fa-user-check text-teal-500"></i> ä¸ªäººèƒ½åŠ›åˆ†æ
                                                </h4>
                                                <p class="text-sm text-gray-600 leading-relaxed">{{ msg.content.personal_analysis }}</p>
                                            </div>

                                            <div v-if="msg.content.industry_opportunities" class="p-4 rounded-xl border border-gray-50 bg-gray-50/30">
                                                <h4 class="font-bold text-gray-800 text-sm mb-2 flex items-center gap-2">
                                                    <i class="fas fa-lightbulb text-yellow-500"></i> è¡Œä¸šæœºä¼šåˆ†æ
                                                </h4>
                                                <p class="text-sm text-gray-600 leading-relaxed">{{ msg.content.industry_opportunities }}</p>
                                            </div>
                                        </div>

                                        <div v-if="msg.content.career_match" class="p-5 rounded-2xl bg-gray-900 text-white">
                                            <div class="flex justify-between items-center mb-4">
                                                <h4 class="font-bold text-sm">ğŸ¯ èŒä¸šåŒ¹é…è¯„ä¼°</h4>
                                                <span class="text-2xl font-black text-orange-400">{{ msg.content.career_match.match_score }}%</span>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div v-if="msg.content.career_match.match_reasons">
                                                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">åŒ¹é…ä¼˜åŠ¿</p>
                                                    <ul class="text-xs space-y-1 text-gray-300">
                                                        <li v-for="reason in msg.content.career_match.match_reasons" class="flex items-start gap-2">
                                                            <i class="fas fa-check text-green-400 mt-0.5"></i> {{ reason }}
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div v-if="msg.content.career_match.concerns">
                                                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">æ½œåœ¨æŒ‘æˆ˜</p>
                                                    <ul class="text-xs space-y-1 text-gray-300">
                                                        <li v-for="concern in msg.content.career_match.concerns" class="flex items-start gap-2">
                                                            <i class="fas fa-exclamation-triangle text-orange-400 mt-0.5"></i> {{ concern }}
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Goals Display -->
                                    <div v-if="msg.type === 'goals'" class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm space-y-6">
                                        <h3 class="font-bold text-xl text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-bullseye text-red-500"></i> èŒä¸šç›®æ ‡æ‹†è§£
                                        </h3>
                                        <div class="space-y-8">
                                            <div v-for="(goals, type) in { 'çŸ­æœŸç›®æ ‡': msg.content.short_term_goals, 'ä¸­æœŸç›®æ ‡': msg.content.medium_term_goals, 'é•¿æœŸç›®æ ‡': msg.content.long_term_goals }" :key="type">
                                                <div v-if="goals && goals.length > 0">
                                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                                        {{ type }}
                                                    </h4>
                                                    <div class="space-y-4">
                                                        <div v-for="goal in goals" :key="goal.title" class="p-4 rounded-xl border border-gray-100 hover:border-orange-200 transition-colors">
                                                            <div class="flex justify-between items-start mb-2">
                                                                <h5 class="font-bold text-gray-900">{{ goal.title }}</h5>
                                                                <span class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-500 font-medium">{{ goal.timeline }}</span>
                                                            </div>
                                                            <p class="text-sm text-gray-600 mb-3">{{ goal.description }}</p>
                                                            <div class="flex flex-wrap gap-2">
                                                                <span v-for="skill in goal.required_skills" class="text-[10px] bg-orange-50 text-orange-600 px-2 py-0.5 rounded-full">{{ skill }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Final Plan Display -->
                                    <div v-if="msg.type === 'plan'" class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm space-y-6">
                                        <h3 class="font-bold text-xl text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-calendar-alt text-orange-500"></i> èŒä¸šè¡ŒåŠ¨è®¡åˆ’
                                        </h3>
                                        
                                        <div v-if="msg.content.weekly_schedule" class="space-y-4">
                                            <div class="grid grid-cols-1 gap-4">
                                                <div v-for="week in msg.content.weekly_schedule" :key="week.week" class="p-4 rounded-xl bg-orange-50/30 border border-orange-100">
                                                    <div class="flex justify-between items-center mb-3">
                                                        <span class="text-sm font-bold text-orange-700">ç¬¬ {{ week.week }} å‘¨</span>
                                                        <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold">{{ week.focus_area }}</span>
                                                    </div>
                                                    <div class="space-y-3">
                                                        <div v-for="(task, tidx) in week.tasks" :key="tidx" class="flex gap-3">
                                                            <div class="w-1 h-1 rounded-full bg-orange-400 mt-2"></div>
                                                            <div class="flex-1">
                                                                <p class="text-sm font-medium text-gray-800">{{ task.task }}</p>
                                                                <div class="flex gap-3 mt-1">
                                                                    <span class="text-[10px] text-gray-400"><i class="far fa-clock"></i> {{ task.duration }}</span>
                                                                    <span v-if="task.priority === 'é«˜'" class="text-[10px] text-red-500 font-bold">é‡è¦</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex items-center gap-4 pt-2">
                                        <button class="message-action-btn"><i class="far fa-bookmark"></i></button>
                                        <button class="message-action-btn"><i class="far fa-thumbs-up"></i></button>
                                        <button class="message-action-btn"><i class="far fa-thumbs-down"></i></button>
                                        <button class="message-action-btn"><i class="far fa-copy"></i></button>
                                        <button class="message-action-btn"><i class="fas fa-volume-up"></i></button>
                                    </div>
                                </div>
                            </div>

                            <!-- User Message -->
                            <div v-else class="flex justify-end items-start gap-4">
                                <div class="user-bubble">
                                    {{ msg.content }}
                                </div>
                                <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-xs font-bold">
                                    {{ profile.name ? profile.name.charAt(0).toUpperCase() : 'U' }}
                                </div>
                            </div>
                        </div>

                        <!-- Streaming Content -->
                        <div v-if="Object.keys(activeNodes).length > 0" class="space-y-6">
                            <div v-for="(info, node) in activeNodes" :key="node">
                                <div v-if="!isParallelNode(node)" class="flex gap-4 items-start">
                                    <div class="bot-icon animate-pulse">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <div class="font-bold text-sm text-gray-400">{{ getNodeLabel(node) }} æ­£åœ¨å¤„ç†...</div>
                                        <div class="text-gray-400 text-sm italic">{{ formatStreamingContent(info.content) || 'æ­£åœ¨æ€è€ƒä¸­...' }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Parallel Nodes Grid -->
                            <div v-if="hasParallelNodes" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div v-for="(info, node) in parallelNodes" :key="node" class="bg-white rounded-2xl border border-orange-100 p-4 shadow-sm flex flex-col h-48">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="text-[10px] font-bold text-orange-600 uppercase tracking-widest flex items-center gap-2">
                                            <i :class="getNodeIcon(node)"></i> {{ getNodeLabel(node) }}
                                        </span>
                                        <span class="flex h-2 w-2">
                                            <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-orange-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-2 w-2 bg-orange-500"></span>
                                        </span>
                                    </div>
                                    <div class="flex-1 overflow-y-auto text-xs text-gray-500 leading-relaxed">
                                        {{ formatStreamingContent(info.content) || 'æ­£åœ¨æ”¶é›†æ•°æ®...' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loading Indicator -->
                        <div v-if="loading" class="flex gap-4 items-start">
                            <div class="bot-icon">
                                <i class="fas fa-circle-notch fa-spin"></i>
                            </div>
                            <div class="flex gap-1 mt-3">
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-300 animate-bounce"></span>
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-300 animate-bounce" style="animation-delay: 0.2s"></span>
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-300 animate-bounce" style="animation-delay: 0.4s"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div v-if="waitingForFeedback" class="p-6 bg-white border-t input-container">
                    <div class="max-w-3xl mx-auto">
                        <!-- Feedback Form -->
                        <div class="space-y-4">
                            <div v-if="pendingQuestions && pendingQuestions.length > 0" class="space-y-2">
                                <p class="text-sm font-bold text-orange-800">AI è¡¥å……æé—®ï¼š</p>
                                <ul class="text-sm space-y-1 text-orange-700">
                                    <li v-for="q in pendingQuestions" class="flex items-start gap-2">
                                        <i class="fas fa-question-circle mt-1"></i> {{ q }}
                                    </li>
                                </ul>
                            </div>
                            <p class="text-sm font-medium text-gray-700">æ‚¨å¯¹ä¸Šè¿°åˆ†ææŠ¥å‘Šæ»¡æ„å—ï¼Ÿ</p>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="level in satisfactionLevels" :key="level.value" 
                                    @click="submitFeedback(level.value)"
                                    class="px-4 py-2 rounded-full text-xs font-medium transition-all border"
                                    :class="feedback.satisfaction === level.value ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-400'">
                                    {{ level.label }}
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <input v-model="feedback.text" type="text" placeholder="è¾“å…¥æ‚¨çš„å…·ä½“æ„è§ (å¯é€‰)" class="flex-1 rounded-xl border-gray-200 focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 p-3 text-sm border">
                                <button @click="submitFeedback(feedback.satisfaction)" class="bg-gray-900 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-black transition-colors">æäº¤åé¦ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Disclaimer (Always show at bottom of chat if not waiting for feedback, or inside input container) -->
                <div v-if="!waitingForFeedback" class="pb-6 pt-2 text-center text-[10px] text-gray-400 bg-white">
                    CareerNavigator å¯èƒ½ä¼šäº§ç”Ÿè¯¯å·®ã€‚è¯·æ ¸å®é‡è¦ä¿¡æ¯ã€‚
                </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, nextTick, watch, computed } = Vue;

        createApp({
            setup() {
                const currentStep = ref('login'); // login, questionnaire, workflow
                const currentStage = ref('initial');
                const loading = ref(false);
                const sessionId = ref(null);
                const chatHistory = ref([]);
                const chatContainer = ref(null);
                const waitingForFeedback = ref(false);
                const pendingQuestions = ref([]);
                const activeNodes = reactive({});
                let pollTimer = null;

                const handleLogin = () => {
                    currentStep.value = 'questionnaire';
                };

                watch(activeNodes, () => {
                    scrollToBottom();
                }, { deep: true });

                const isParallelNode = (node) => {
                    return ['user_profiler', 'industry_researcher', 'job_analyzer'].includes(node);
                };

                const formatStreamingContent = (text) => {
                    if (!text) return '';
                    // ç§»é™¤ markdown ä»£ç å—æ ‡è¯†å’Œ JSON ç»“æ„å­—ç¬¦
                    let cleanText = text.replace(/```json|```|\{|\}|\[|\]|"|:/g, '');
                    
                    // å¦‚æœå¤„ç†åè¿˜æœ‰å†…å®¹ï¼Œæå–ä¸­æ–‡å­—ç¬¦ã€æ•°å­—å’Œå¸¸ç”¨æ ‡ç‚¹
                    const matches = cleanText.match(/[\u4e00-\u9fa50-9ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€\s]/g);
                    if (matches) {
                        const result = matches.join('').replace(/\s+/g, ' ').trim();
                        return result || 'æ­£åœ¨æ•´ç†ç»“æ„åŒ–æ•°æ®...';
                    }
                    return 'æ­£åœ¨æ•´ç†ç»“æ„åŒ–æ•°æ®...';
                };

                const parallelNodes = computed(() => {
                    const nodes = {};
                    for (const node in activeNodes) {
                        if (isParallelNode(node)) {
                            nodes[node] = activeNodes[node];
                        }
                    }
                    return nodes;
                });

                const hasParallelNodes = computed(() => Object.keys(parallelNodes.value).length > 0);

                const getNodeLabel = (node) => {
                    const labels = {
                        'coordinator': 'åè°ƒå‘˜',
                        'planner': 'è®¡åˆ’å‘˜',
                        'supervisor': 'ç®¡ç†å‘˜',
                        'user_profiler': 'ä¸ªäººç”»åƒåˆ†æ',
                        'industry_researcher': 'è¡Œä¸šè¶‹åŠ¿ç ”ç©¶',
                        'job_analyzer': 'èŒä¸šæœºä¼šåˆ†æ',
                        'reporter': 'æ±‡æŠ¥å‘˜',
                        'goal_decomposer': 'ç›®æ ‡æ‹†è§£å‘˜',
                        'scheduler': 'æ—¥ç¨‹è§„åˆ’å‘˜',
                        'system': 'ç³»ç»Ÿ'
                    };
                    return labels[node] || node;
                };

                const getNodeIcon = (node) => {
                    const icons = {
                        'user_profiler': 'fas fa-user-cog',
                        'industry_researcher': 'fas fa-chart-line',
                        'job_analyzer': 'fas fa-briefcase',
                        'coordinator': 'fas fa-route',
                        'planner': 'fas fa-clipboard-list',
                        'goal_decomposer': 'fas fa-tasks',
                        'scheduler': 'fas fa-calendar-alt'
                    };
                    return icons[node] || 'fas fa-robot';
                };

                const profile = reactive({
                    name: '',
                    age: 28,
                    education_level: 'æœ¬ç§‘',
                    work_experience: 3,
                    current_position: 'è½¯ä»¶å·¥ç¨‹å¸ˆ',
                    industry: 'äº’è”ç½‘',
                    location: 'åŒ—äº¬',
                    career_goals: 'å¸Œæœ›è½¬å‘ AI äº§å“ç»ç†æ–¹å‘å‘å±•',
                    salary_expectation: '30-50ä¸‡'
                });

                const skillsInput = ref('Python, JavaScript, React, SQL');
                const interestsInput = ref('äººå·¥æ™ºèƒ½, äº§å“è®¾è®¡, å¿ƒç†å­¦');

                const feedback = reactive({
                    satisfaction: 'satisfied',
                    text: ''
                });

                const satisfactionLevels = [
                    { label: 'éå¸¸æ»¡æ„', value: 'very_satisfied' },
                    { label: 'æ»¡æ„', value: 'satisfied' },
                    { label: 'ä¸€èˆ¬', value: 'neutral' },
                    { label: 'ä¸æ»¡æ„', value: 'dissatisfied' },
                    { label: 'éå¸¸ä¸æ»¡æ„', value: 'very_dissatisfied' }
                ];

                const scrollToBottom = async () => {
                    await nextTick();
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                };

                const addMessage = (role, content, type = 'text') => {
                    chatHistory.value.push({ role, content, type });
                    scrollToBottom();
                };

                const startPlanning = async () => {
                    loading.value = true;
                    try {
                        const payload = {
                            user_profile: {
                                ...profile,
                                skills: skillsInput.value.split(',').map(s => s.trim()).filter(s => s),
                                interests: interestsInput.value.split(',').map(s => s.trim()).filter(s => s)
                            },
                            message: `æˆ‘æƒ³è¿›è¡ŒèŒä¸šè§„åˆ’ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯ï¼š${profile.career_goals}`
                        };

                        const response = await axios.post('/api/career/start', payload);
                        if (response.data.success) {
                            sessionId.value = response.data.session_id;
                            currentStep.value = 'workflow';
                            addMessage('user', payload.message);
                            addMessage('bot', 'æ”¶åˆ°ï¼æˆ‘å·²å¼€å§‹ä¸ºæ‚¨åˆ†æèŒä¸šè·¯å¾„ï¼Œè¯·ç¨å€™...');
                            
                            // Start streaming
                            startStreaming();
                            // Start polling for status (to get final results)
                            pollStatus();
                        }
                    } catch (error) {
                        console.error(error);
                        alert('å¯åŠ¨å¤±è´¥: ' + (error.response?.data?.error || error.message));
                    } finally {
                        loading.value = false;
                    }
                };

                const startStreaming = () => {
                    if (!sessionId.value) return;
                    
                    // Reset active nodes
                    for (const key in activeNodes) delete activeNodes[key];
                    activeNodes['system'] = { content: 'æ­£åœ¨å‡†å¤‡å·¥ä½œæµ...', status: 'start' };
                    
                    const eventSource = new EventSource(`/api/career/stream?session_id=${sessionId.value}`);
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.status === 'completed' || data.status === 'error') {
                            eventSource.close();
                            // Clear active nodes after a short delay to let user see completion
                            setTimeout(() => {
                                for (const key in activeNodes) delete activeNodes[key];
                            }, 2000);
                            return;
                        }

                        if (data.node) {
                            if (data.status === 'start') {
                                // å¦‚æœæ˜¯å¹¶è¡ŒèŠ‚ç‚¹ï¼Œç›´æ¥æ·»åŠ 
                                if (isParallelNode(data.node)) {
                                    activeNodes[data.node] = { content: '', status: 'start' };
                                } else {
                                    // å¦‚æœæ˜¯é¡ºåºèŠ‚ç‚¹ï¼ˆå¦‚ coordinator, planner, supervisor, reporterï¼‰
                                    // åªæœ‰åœ¨ä¸æ˜¯ reporter çš„æ—¶å€™æ‰æ¸…ç©ºå¹¶è¡ŒèŠ‚ç‚¹
                                    // è¿™æ ·å¹¶è¡Œåˆ†æçš„ç»“æœå¯ä»¥ä¸€ç›´æ˜¾ç¤ºåˆ°æŠ¥å‘Šç”Ÿæˆ
                                    if (data.node !== 'reporter' && data.node !== 'system') {
                                        for (const key in activeNodes) {
                                            delete activeNodes[key];
                                        }
                                    } else if (data.node === 'reporter') {
                                        // reporter å¼€å§‹æ—¶ï¼Œåªåˆ é™¤ä¹‹å‰çš„é¡ºåºèŠ‚ç‚¹ï¼Œä¿ç•™å¹¶è¡ŒèŠ‚ç‚¹
                                        for (const key in activeNodes) {
                                            if (!isParallelNode(key)) delete activeNodes[key];
                                        }
                                    }
                                    
                                    activeNodes[data.node] = { content: '', status: 'start' };
                                }
                                
                                // ç§»é™¤ç³»ç»Ÿæ¶ˆæ¯
                                if (data.node !== 'system' && activeNodes['system']) {
                                    delete activeNodes['system'];
                                }
                            } else if (data.status === 'end') {
                                if (activeNodes[data.node]) {
                                    activeNodes[data.node].status = 'end';
                                    // For parallel nodes, we might want to keep them until all are done
                                    // For sequential nodes, we can remove them or keep them briefly
                                    if (['coordinator', 'planner', 'supervisor', 'reporter', 'goal_decomposer', 'scheduler'].includes(data.node)) {
                                        setTimeout(() => {
                                            delete activeNodes[data.node];
                                        }, 1000);
                                    }
                                }
                            } else if (data.content) {
                                if (!activeNodes[data.node]) {
                                    activeNodes[data.node] = { content: '', status: 'running' };
                                }
                                activeNodes[data.node].content += data.content;
                                activeNodes[data.node].status = 'running';
                            }
                        }
                    };

                    eventSource.onerror = (error) => {
                        console.error('Streaming error:', error);
                        eventSource.close();
                    };
                };

                const pollStatus = async () => {
                    if (!sessionId.value) return;
                    
                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢é‡å¤è½®è¯¢
                    if (pollTimer) {
                        clearTimeout(pollTimer);
                        pollTimer = null;
                    }
                    
                    try {
                        const response = await axios.get(`/api/career/status/${sessionId.value}`);
                        const data = response.data;
                        
                        // ä¿®æ­£å­—æ®µè¯»å–è·¯å¾„
                        currentStage.value = data.stage_info.current_stage;
                        pendingQuestions.value = data.stage_info.pending_questions || [];
                        
                        // æ£€æŸ¥ç»“æœ
                        if (data.results.integrated_report) {
                            const report = data.results.integrated_report;
                            const alreadyDisplayed = chatHistory.value.some(m => 
                                m.type === 'report' && 
                                (m.content.iteration_count !== undefined && report.iteration_count !== undefined ? 
                                 m.content.iteration_count === report.iteration_count : 
                                 JSON.stringify(m.content) === JSON.stringify(report))
                            );
                            
                            if (!alreadyDisplayed) {
                                // å¦‚æœæŠ¥å‘Šä¸­æœ‰é”™è¯¯ä¿¡æ¯ï¼Œæ·»åŠ åˆ°å†…å®¹ä¸­æ˜¾ç¤º
                                if (report.error) {
                                    report.executive_summary = "âš ï¸ åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: " + report.error;
                                }
                                addMessage('bot', report, 'report');
                            }
                        }

                        if (data.results.career_goals) {
                            const goals = data.results.career_goals;
                            const alreadyDisplayed = chatHistory.value.some(m => 
                                m.type === 'goals' && 
                                (m.content.iteration_count !== undefined && goals.iteration_count !== undefined ? 
                                 m.content.iteration_count === goals.iteration_count : 
                                 JSON.stringify(m.content) === JSON.stringify(goals))
                            );
                            
                            if (!alreadyDisplayed) {
                                addMessage('bot', goals, 'goals');
                            }
                        }

                        if (data.results.final_career_plan) {
                            const plan = data.results.final_career_plan;
                            const alreadyDisplayed = chatHistory.value.some(m => 
                                m.type === 'plan' && 
                                (m.content.iteration_count !== undefined && plan.iteration_count !== undefined ? 
                                 m.content.iteration_count === plan.iteration_count : 
                                 JSON.stringify(m.content) === JSON.stringify(plan))
                            );
                            
                            if (!alreadyDisplayed) {
                                addMessage('bot', plan, 'plan');
                            }
                        }

                        // Check if waiting for feedback
                        if (data.stage_info.requires_user_input) {
                            waitingForFeedback.value = true;
                            loading.value = false;
                            // åœæ­¢è½®è¯¢ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
                        } else if (currentStage.value === 'completed') {
                            waitingForFeedback.value = false;
                            loading.value = false;
                            // åœæ­¢è½®è¯¢ï¼Œæµç¨‹ç»“æŸ
                        } else {
                            // ç»§ç»­è½®è¯¢
                            pollTimer = setTimeout(pollStatus, 2000);
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                        // å‡ºé”™ä¹Ÿå°è¯•ç»§ç»­è½®è¯¢ï¼Œé™¤éä¼šè¯å¤±æ•ˆ
                        pollTimer = setTimeout(pollStatus, 5000);
                    }
                };

                const submitFeedback = async (level) => {
                    feedback.satisfaction = level;
                    loading.value = true;
                    waitingForFeedback.value = false;
                    
                    try {
                        addMessage('user', `æ»¡æ„åº¦: ${satisfactionLevels.find(l => l.value === level).label}. ${feedback.text}`);
                        
                        const response = await axios.post(`/api/career/feedback/${sessionId.value}`, {
                            satisfaction_level: level,
                            feedback_text: feedback.text
                        });
                        
                        if (response.data.success) {
                            addMessage('bot', response.data.message);
                            feedback.text = '';
                            // é‡æ–°å¼€å§‹æµå¼ç›‘å¬ï¼Œä»¥è§¦å‘åç»­æµç¨‹
                            startStreaming();
                            pollStatus();
                        }
                    } catch (error) {
                        console.error(error);
                        alert('æäº¤åé¦ˆå¤±è´¥');
                        waitingForFeedback.value = true;
                    } finally {
                        loading.value = false;
                    }
                };

                const reset = () => {
                    currentStep.value = 'login';
                    chatHistory.value = [];
                    sessionId.value = null;
                    waitingForFeedback.value = false;
                };

                return {
                    currentStep, profile, skillsInput, interestsInput, loading,
                    startPlanning, chatHistory, chatContainer, waitingForFeedback,
                    satisfactionLevels, feedback, submitFeedback, currentStage, reset,
                    activeNodes, getNodeLabel, getNodeIcon, isParallelNode, parallelNodes, hasParallelNodes,
                    handleLogin, formatStreamingContent
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
